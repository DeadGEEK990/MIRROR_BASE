{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="chat-container">
    <!-- Сайдбар -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h3>Мои чаты</h3>
            <button id="create-chat-btn" class="btn btn-primary">Создать чат</button>
        </div>
        <div id="chat-list" class="chat-list">
            {% for chat in request.user.chat_rooms.all %}
            <div class="chat-list-item {% if chat.id == current_chat.id %}active{% endif %}" 
                 data-chat-id="{{ chat.id }}">
                {{ chat.name }}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Основная область -->
    <div class="chat-main">
        <div class="chat-header">
            <h2 id="current-chat-name">
                {% if current_chat %}{{ current_chat.name }}{% else %}Выберите чат{% endif %}
            </h2>
        </div>

        <div class="messages-container" id="messages-container">
            <div id="chat-messages">
                {% include "chats/messages_partial.html" %}
            </div>
        </div>

        <div class="message-input" id="message-input-area" 
             {% if not current_chat %}style="display: none;"{% endif %}>
            <textarea id="message-text" placeholder="Введите сообщение..."></textarea>
            <button id="send-message-btn">Отправить</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let chatSocket;
    let currentChatId = {% if current_chat %}{{ current_chat.id }}{% else %}null{% endif %};

    // Инициализация WebSocket
    function initWebSocket(chatId) {
        if (chatSocket) {
            chatSocket.close();
        }

        currentChatId = chatId;
        chatSocket = new WebSocket(
            'ws://' + window.location.host +
            '/ws/chat/' + chatId + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'new_message') {
                // Перезагружаем сообщения через формсет
                loadChatMessages(chatId);
            }
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
            setTimeout(() => {
                if (currentChatId) initWebSocket(currentChatId);
            }, 5000);
        };
    }

    // Загрузка сообщений через формсет
    function loadChatMessages(chatId) {
        fetch(`/chats/${chatId}/`)
            .then(response => response.text())
            .then(html => {
                document.getElementById('chat-messages').innerHTML = html;
                scrollToBottom();
            });
    }

    // Загрузка всего чата
    function loadChat(chatId) {
        loadChatMessages(chatId);
        document.getElementById('message-input-area').style.display = 'flex';
        document.getElementById('current-chat-name').textContent = 
            document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`).textContent;
        
        document.querySelectorAll('.chat-list-item').forEach(item => {
            item.classList.remove('active');
        });
        document.querySelector(`.chat-list-item[data-chat-id="${chatId}"]`).classList.add('active');
        
        initWebSocket(chatId);
    }

    function scrollToBottom() {
        const container = document.getElementById('messages-container');
        container.scrollTop = container.scrollHeight;
    }

    // Обработчики событий
    document.querySelectorAll('.chat-list-item').forEach(item => {
        item.addEventListener('click', function() {
            loadChat(this.getAttribute('data-chat-id'));
        });
    });

    document.getElementById('send-message-btn').addEventListener('click', sendMessage);
    document.getElementById('message-text').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const messageInput = document.getElementById('message-text');
        const message = messageInput.value.trim();
        
        if (message && currentChatId && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));
            messageInput.value = '';
        }
    }

    // Инициализация при загрузке
    if (currentChatId) {
        initWebSocket(currentChatId);
        scrollToBottom();
    }

    document.getElementById('create-chat-btn').addEventListener('click', function() {
        window.location.href = "{% url 'chat_create' %}";
    });
});
</script>

<style>
.chat-container {
    display: flex;
    height: calc(100vh - 60px);
}

.sidebar {
    width: 300px;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
}

.sidebar-header {
    padding: 15px;
    border-bottom: 1px solid #ddd;
}

.chat-list {
    flex: 1;
    overflow-y: auto;
}

.chat-list-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.chat-list-item:hover {
    background-color: #f5f5f5;
}

.chat-list-item.active {
    background-color: #e3f2fd;
}

.chat-main {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 15px;
    border-bottom: 1px solid #ddd;
}

.messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
}

.message-input {
    padding: 15px;
    border-top: 1px solid #ddd;
    display: flex;
}

#message-text {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: none;
}

#send-message-btn {
    margin-left: 10px;
    padding: 0 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
</style>
{% endblock %}